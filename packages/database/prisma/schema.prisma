// This is your Prisma schema file
// For more information: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  role          String  @default("LENDER")
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  profile       UserProfile?
  lenderProfile LenderProfile?
  loanRequests  LoanRequest[]
  allocations   Allocation[]
  activities    Activity[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserProfile {
  id              String  @id @default(cuid())
  userId          String  @unique
  company         String?
  position        String?
  phone           String?
  address         String?
  city            String?
  country         String?
  taxId           String?
  kycVerified     Boolean @default(false)
  kycDocumentUrl  String?
  accreditedInvestor Boolean @default(false)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ==================== LENDER ====================

model LenderProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  institutionName   String
  institutionType   String
  aum               Float?   // Assets Under Management
  investmentFocus   String?    // Array of focus areas
  riskAppetite      String   @default("MODERATE") // LOW, MODERATE, HIGH
  minInvestment     Float    @default(100000)
  maxInvestment     Float?
  preferredSectors  String?    // Array of sectors
  esgPreferences    String?    // ESG criteria
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  allocations Allocation[]
  bids        Bid[]

  @@map("lender_profiles")
}

// ==================== LOAN ====================

model LoanRequest {
  id                String      @id @default(cuid())
  borrowerId        String
  title             String
  description       String
  amount            Float
  currency          String      @default("USD")
  term              Int         // months
  interestRate      Float
  purpose           String
  status            String  @default("DRAFT")
  visibility        String  @default("PRIVATE")
  
  // Dates
  applicationDate   DateTime    @default(now())
  targetCloseDate   DateTime?
  actualCloseDate   DateTime?
  
  // Document storage
  documentUrls      String?       // Array of document URLs
  
  // AI-extracted data
  structuredData    String?       // AI-parsed loan data
  riskScore         Float?
  creditRating      String?
  
  // ESG Metrics
  esgScore          Float?
  carbonIntensity   Float?
  esgData           String?
  
  // Syndication
  syndicationTarget Float?      // Target amount to syndicate
  syndicationMin    Float?      // Minimum syndication amount
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  borrower          User         @relation(fields: [borrowerId], references: [id])
  documents         Document[]
  covenants         Covenant[]
  allocations       Allocation[]
  secondaryOffers   SecondaryOffer[]
  bids              Bid[]
  activities        Activity[]

  @@index([status])
  @@index([borrowerId])
  @@map("loan_requests")
}

// ==================== DOCUMENTS ====================

model Document {
  id              String   @id @default(cuid())
  loanRequestId   String
  type            String   // CIM, TERM_SHEET, CREDIT_AGREEMENT, etc.
  name            String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  uploadedAt      DateTime @default(now())
  
  // AI Processing
  processed       Boolean  @default(false)
  extractedData   String?    // AI-extracted structured data
  vectorEmbedding String?  // For semantic search
  
  loanRequest     LoanRequest @relation(fields: [loanRequestId], references: [id], onDelete: Cascade)

  @@index([loanRequestId])
  @@map("documents")
}

// ==================== ALLOCATION ====================

model Allocation {
  id              String           @id @default(cuid())
  loanRequestId   String
  lenderId        String
  lenderProfileId String
  amount          Float
  percentage      Float
  status          String @default("PROPOSED")
  proposedBy      String           @default("AI") // AI, ARRANGER, LENDER
  confidence      Float?           // AI confidence score
  reasoning       String?
  
  // Terms
  interestRate    Float?
  fees            String?            // Array of fee structures
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  loanRequest     LoanRequest      @relation(fields: [loanRequestId], references: [id], onDelete: Cascade)
  lender          User             @relation(fields: [lenderId], references: [id])
  lenderProfile   LenderProfile    @relation(fields: [lenderProfileId], references: [id])

  @@index([loanRequestId])
  @@index([lenderId])
  @@map("allocations")
}

// ==================== COVENANT MONITORING ====================

model Covenant {
  id              String           @id @default(cuid())
  loanRequestId   String
  type            String
  name            String
  description     String
  threshold       Float?
  frequency       String           // MONTHLY, QUARTERLY, ANNUALLY
  nextCheckDate   DateTime
  status          String   @default("COMPLIANT")
  
  // Monitoring
  lastCheckedAt   DateTime?
  lastValue       Float?
  alertThreshold  Float?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  loanRequest     LoanRequest      @relation(fields: [loanRequestId], references: [id], onDelete: Cascade)
  checks          CovenantCheck[]

  @@index([loanRequestId])
  @@index([status])
  @@index([nextCheckDate])
  @@map("covenants")
}

model CovenantCheck {
  id          String   @id @default(cuid())
  covenantId  String
  checkedAt   DateTime @default(now())
  value       Float
  status      String
  notes       String?
  alertSent   Boolean  @default(false)
  
  covenant    Covenant @relation(fields: [covenantId], references: [id], onDelete: Cascade)

  @@index([covenantId])
  @@map("covenant_checks")
}

// ==================== SECONDARY MARKET ====================

model SecondaryOffer {
  id              String              @id @default(cuid())
  loanRequestId   String
  sellerId        String
  amount          Float
  askingPrice     Float
  discount        Float?
  status          String @default("ACTIVE")
  description     String?
  
  // Due Diligence
  dueDiligenceUrl String?
  aiDDReport      String?               // AI-generated DD report
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  expiresAt       DateTime?
  
  loanRequest     LoanRequest         @relation(fields: [loanRequestId], references: [id])
  bids            Bid[]

  @@index([loanRequestId])
  @@index([status])
  @@map("secondary_offers")
}

model Bid {
  id                String         @id @default(cuid())
  secondaryOfferId  String?        // For secondary market
  loanRequestId     String?        // For primary syndication
  bidderId          String
  lenderProfileId   String
  amount            Float
  price             Float
  status            String      @default("PENDING")
  
  createdAt         DateTime       @default(now())
  expiresAt         DateTime?
  
  secondaryOffer    SecondaryOffer? @relation(fields: [secondaryOfferId], references: [id])
  loanRequest       LoanRequest?    @relation(fields: [loanRequestId], references: [id])
  lenderProfile     LenderProfile   @relation(fields: [lenderProfileId], references: [id])

  @@index([secondaryOfferId])
  @@index([loanRequestId])
  @@index([bidderId])
  @@map("bids")
}

// ==================== ACTIVITY LOG ====================

model Activity {
  id              String   @id @default(cuid())
  userId          String?
  loanRequestId   String?
  type            String
  description     String
  metadata        String?
  createdAt       DateTime @default(now())
  
  user            User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  loanRequest     LoanRequest? @relation(fields: [loanRequestId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([loanRequestId])
  @@index([createdAt])
  @@map("activities")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  message     String
  read        Boolean  @default(false)
  actionUrl   String?
  metadata    String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}
